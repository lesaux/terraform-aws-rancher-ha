resource "aws_elb" "rancher-server-internal" {
  name                      = "${var.environment}-rancher-internal"
  subnets                   = ["${split(",", var.rancher_servers_private_subnets_ids)}"]
  security_groups           = ["${split(",", var.rancher_servers_security_groups)}"]
  cross_zone_load_balancing = true
  internal                  = true

  listener {
    instance_port      = 80
    instance_protocol  = "http"
    lb_port            = 80
    lb_protocol        = "http"
  }

  listener {
    instance_port      = 18080
    instance_protocol  = "http"
    lb_port            = 18080
    lb_protocol        = "http"
  }

  health_check {
    healthy_threshold   = 2
    unhealthy_threshold = 2
    timeout             = 3
    target              = "HTTP:80/ping"
    interval            = 30
  }

  # Only 1st instance per subnet will be a server
  instances                   = ["${aws_instance.rancher-servers.*.id}"]
  cross_zone_load_balancing   = true
  idle_timeout                = 400
  connection_draining         = true
  connection_draining_timeout = 400

  tags {
    Name = "${var.environment}-rancher"
  }
}

resource "aws_proxy_protocol_policy" "rancher-internal" {
  load_balancer  = "${aws_elb.rancher-server-internal.name}"
  instance_ports = ["80"]
}

resource "aws_route53_record" "rancher-int" {
  zone_id = "${var.internal_domain_zone_id}"
  name    = "rancher"
  type    = "CNAME"
  ttl     = "60"
  records = ["${aws_elb.rancher-server-internal.dns_name}"]
}
